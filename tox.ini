[tox]
envlist = {py37,py38,py39}{-pt19,-pt110}{-cuda,},docker{-cputest,-buildimage}
requires = tox-conda

[testenv]
description =
    py37: Python 3.7
    py38: Python 3.8
    py39: Python 3.9
    pt19: PyTorch 1.9
    pt110: PyTorch 1.10
    !cuda: CPU
    cuda: CUDA 11.3
deps =
    -r{toxinidir}/tests/requirements.txt
conda_deps =
    # PyTorch 1.9
    pt19: pytorch==1.9.1
    pt19: torchvision==0.10.1
    # PyTorch 1.10
    pt110: pytorch==1.10.1
    pt110: torchvision==0.11.2
    # GPU support
    cuda: cudatoolkit=11.1
    libjpeg-turbo
conda_channels =
    conda-forge
    pytorch
    nvidia
passenv =
    AWS_ACCESS_KEY_ID
    AWS_SECRET_ACCESS_KEY
    MLMODULE_BUILD_VERSION
commands =
    black --check src tests
    pytest []

[testenv:docker{-cputest,-buildimage}]
envdir = {toxworkdir}/docker
description = Environment to test MLModule on the lsirepfl/pytorch image
deps =
    build
conda_deps =
conda_channels =
extras =
setenv =
    BASE_IMAGE = lsirepfl/mlmodulekit:3
    MLMODULE_BUILD_VERSION = {env:MLMODULE_BUILD_VERSION:0.0.dev0}
    cputest: CPU_ONLY_TESTS = y
    buildimage: BASE_IMAGE = mlmodulekit-build
allowlist_externals =
    docker
commands =
    buildimage: docker build -f mlmodulekit/Dockerfile.binaries -t {env:BASE_IMAGE} mlmodulekit
    docker build \
		--build-arg MLMODULE_BUILD_VERSION={env:MLMODULE_BUILD_VERSION} \
		--build-arg BASE_IMAGE={env:BASE_IMAGE} \
		--build-arg DISTDIR=.tox/dist \
		-f tests/Dockerfile.test \
		-t test-mlmodule/{env:BASE_IMAGE}-{env:MLMODULE_BUILD_VERSION} .
    docker run --rm \
		-e AWS_ACCESS_KEY_ID={env:AWS_ACCESS_KEY_ID} \
		-e AWS_SECRET_ACCESS_KEY={env:AWS_SECRET_ACCESS_KEY} \
		-e CPU_ONLY_TESTS={env:CPU_ONLY_TESTS:n} \
        -v {toxworkdir}/.pytest:/app/.pytest \
		test-mlmodule/{env:BASE_IMAGE}-{env:MLMODULE_BUILD_VERSION} \
		conda run -n app --no-capture-output pytest []
commands_post =
    buildimage: docker rmi {env:BASE_IMAGE}
    docker rmi test-mlmodule/{env:BASE_IMAGE}-{env:MLMODULE_BUILD_VERSION}
