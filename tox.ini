[tox]
envlist = {cuda110-,cuda110-pc32-,}py37,docker-{cuda110-,cuda110-pc32-}{cputest-,}py37
requires = tox-conda

[testenv]
description = 
    !cuda110-!pc32: Installs a conda environment with CPU only support
    cuda110-!pc32: Installs a conda environment with CUDA 11.0
    cuda110-pc32: Installs a conda environment with CUDA 11.0 and compiled PyTorch for PC32
deps =
    pytest
    pc32: {env:LSIR_PUBLIC_ASSETS_DIR:/mnt/storage01/lsir-public-assets}/wheels/pytorch/torch-1.7.1-cp37-cp37m-linux_x86_64.whl
    pc32: {env:LSIR_PUBLIC_ASSETS_DIR:/mnt/storage01/lsir-public-assets}/wheels/torchvision/torchvision-0.8.2-cp37-cp37m-linux_x86_64.whl
conda_deps =
    !pc32: pytorch==1.7.1
    !pc32: torchvision==0.8.2
    cuda110: cudatoolkit=11.0
conda_channels =
    pytorch
extras =
    full
    test
passenv =
    AWS_ACCESS_KEY_ID
    AWS_SECRET_ACCESS_KEY
    MLMODULE_BUILD_VERSION
commands =
    pytest tests

[testenv:docker-{cuda110-,cuda110-pc32-}{cputest-,}py37]
description = Environment to test MLModule on the lsirepfl/pytorch image
deps =
    build
conda_deps =
conda_channels =
extras =
skip_install = true
setenv =
    cuda110-pc32-py37: BASE_IMAGE = lsirepfl/pytorch:pc32-v1.7.1-py3.7.10-cu110
    cuda110-!pc32-py37: BASE_IMAGE = lsirepfl/pytorch:v1.7.1-py3.7.10-cu110
    MLMODULE_BUILD_VERSION = {env:MLMODULE_BUILD_VERSION:0.0.dev0}
    cputest: CPU_ONLY_TESTS = y
allowlist_externals =
    docker
commands =
    python -m build --wheel
    docker build \
		--build-arg MLMODULE_BUILD_VERSION={env:MLMODULE_BUILD_VERSION} \
		--build-arg BASE_IMAGE={env:BASE_IMAGE} \
		-f tests/Dockerfile.test \
		-t test-mlmodule/{env:BASE_IMAGE}-{env:MLMODULE_BUILD_VERSION} .
    docker run --rm \
		-e AWS_ACCESS_KEY_ID={env:AWS_ACCESS_KEY_ID} \
		-e AWS_SECRET_ACCESS_KEY={env:AWS_SECRET_ACCESS_KEY} \
		-e CPU_ONLY_TESTS={env:CPU_ONLY_TESTS:n} \
		test-mlmodule/{env:BASE_IMAGE}-{env:MLMODULE_BUILD_VERSION} \
		conda run -n app --no-capture-output pytest /app/tests
commands_post =
    docker rm test-mlmodule/{env:BASE_IMAGE}-{env:MLMODULE_BUILD_VERSION}
